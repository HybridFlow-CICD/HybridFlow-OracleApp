name: CI/CD OracleApp - HybridFlow

on:
  push:
    branches:
      - pablo-dev
      - luis-dev
      - develop
      - main

concurrency:
  group: oracleapp-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test:
    name: Build, Test & Quality Check
    runs-on: self-hosted

    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4

      - name: Mostrar entorno del runner
        run: |
          echo "‚úÖ Runner activo: $(hostname)"
          uname -a

      # ---------- FRONTEND ----------
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Instalar dependencias frontend
        working-directory: ./frontend
        run: npm ci

      - name: Ejecutar pruebas Jest del frontend
        env:
          CI: true
        working-directory: ./frontend
        run: npm test -- --watchAll=false

      # ---------- BACKEND ----------
      - name: Verificar PHP y Composer
        run: |
          php -v
          composer --version || (
            echo "üõ† Instalando Composer..." &&
            EXPECTED_SIGNATURE="$(wget -q -O - https://composer.github.io/installer.sig)" &&
            php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');" &&
            ACTUAL_SIGNATURE="$(php -r "echo hash_file('sha384', 'composer-setup.php');")" &&
            [ "$EXPECTED_SIGNATURE" = "$ACTUAL_SIGNATURE" ] || (echo "Firma inv√°lida"; exit 1) &&
            sudo php composer-setup.php --install-dir=/usr/local/bin --filename=composer &&
            rm composer-setup.php
          )
          composer --version

      - name: Cach√© de Composer
        uses: actions/cache@v4
        with:
          path: |
            ~/.composer/cache/files
            backend/vendor
          key: composer-${{ hashFiles('backend/composer.lock') }}
          restore-keys: |
            composer-

      - name: Instalar dependencias backend
        working-directory: ./backend
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Preparar entorno Laravel (.env y APP_KEY)
        working-directory: ./backend
        run: |
          set -e
          if [ ! -f .env ]; then
            cp .env.example .env || true
          fi
          php artisan key:generate --force

      - name: Ejecutar pruebas backend (PHPUnit)
        working-directory: ./backend
        run: |
          if ls tests/Feature/*.php >/dev/null 2>&1 || ls tests/Unit/*.php >/dev/null 2>&1; then
            php artisan test --no-interaction
          else
            echo "‚ÑπÔ∏è No hay pruebas en Laravel, se omite este paso."
          fi

      # ---------- Lint/Quality ----------
      - name: Analizar calidad del c√≥digo PHP (Laravel)
        working-directory: ./backend
        run: |
          composer require --dev phpstan/phpstan
          vendor/bin/phpstan analyse --level=5 app || true

      - name: Analizar calidad del c√≥digo React (ESLint)
        working-directory: ./frontend
        run: |
          npm install eslint --save-dev
          npx eslint src || true

  # =========================================================
  # DEPLOY DEV (ramas: develop y pablo-dev)
  # =========================================================
  deploy-dev:
    name: Deploy to Development (Proxmox)
    needs: build-test
    if: contains(fromJson('["refs/heads/develop", "refs/heads/pablo-dev"]'), github.ref)
    runs-on: self-hosted

    steps:
      - name: Desplegar aplicaci√≥n en entorno DEV (Ubuntu Proxmox)
        run: |
          echo "üöÄ Desplegando en VM Ubuntu (Proxmox - 10.50.31.23)..."
          ssh -o StrictHostKeyChecking=no ubuntu@10.50.31.23 "
            set -e

            echo 'üß© Preparando entorno PHP con soporte Oracle...'
            sudo apt update -y &&
            sudo apt install -y php-dev php-pear libaio1 unzip &&
            if ! php -m | grep -q oci8; then
              echo '‚öôÔ∏è Instalando extensi√≥n OCI8 (instantclient)...'
              sudo pecl install oci8 <<<'instantclient,/opt/oracle/instantclient' || true
            fi

            # --- Forzar activaci√≥n de oci8 globalmente ---
            PHP_INI_PATH=\$(php --ini | grep 'Loaded Configuration' | awk '{print \$4}')
            echo 'extension=oci8.so' | sudo tee /etc/php/\$(php -r 'echo PHP_MAJOR_VERSION.\".\".PHP_MINOR_VERSION;')/cli/conf.d/20-oci8.ini
            echo 'extension=oci8.so' | sudo tee -a \$PHP_INI_PATH
            sudo systemctl restart apache2 || true
            echo '‚úÖ Extensiones PHP activas:' && php -m | grep oci || echo '‚ùå OCI8 no encontrada'

            echo 'üöÄ Actualizando c√≥digo del proyecto...'
            cd /var/www/html/HybridFlow-OracleApp &&
            sudo chown -R ubuntu:ubuntu /var/www/html/HybridFlow-OracleApp &&
            git fetch origin develop &&
            git reset --hard origin/develop &&
            git pull origin develop &&

            echo 'üßπ Preparando backend Laravel...'
            cd backend &&
            composer install --no-interaction --prefer-dist --optimize-autoloader &&

            # --- Instalar paquete Laravel OCI8 ---
            if ! composer show | grep -q 'yajra/laravel-oci8'; then
              echo 'üì¶ Instalando Yajra OCI8 para Laravel...'
              composer require yajra/laravel-oci8:^9.5 --no-interaction || true
            fi

            # --- Verificar y agregar Provider autom√°ticamente ---
            echo 'üß† Verificando Provider Yajra en config/app.php...'
            if ! grep -q 'Yajra\\\\Oci8\\\\Oci8ServiceProvider::class' config/app.php; then
              echo '‚öôÔ∏è Agregando Provider Oci8ServiceProvider a config/app.php'
              sed -i '/Package Service Providers.../a\    Yajra\\\\Oci8\\\\Oci8ServiceProvider::class,' config/app.php
            fi

            php artisan config:clear &&
            php artisan cache:clear &&
            php artisan optimize:clear &&
            php artisan config:cache &&

            echo 'ü©∫ Verificando conexi√≥n directa a Oracle (Tinker)...'
            php -m | grep oci8 || (echo '‚ùå OCI8 no se carg√≥ en PHP'; exit 1)

            if php artisan tinker --execute=\"DB::connection()->getPdo(); echo '‚úÖ Conectado correctamente a orclpdb';\"; then
              echo '‚úÖ Conexi√≥n exitosa, ejecutando migraciones...'
              composer dump-autoload -o &&
              php artisan migrate --force
            else
              echo '‚ùå Fall√≥ la conexi√≥n a Oracle, no se ejecutar√°n migraciones.'
              exit 1
            fi
          "

      - name: Validar conexi√≥n Oracle (Health Check)
        run: |
          echo "ü©∫ Verificando conexi√≥n HTTP a Oracle (post-deploy)..."
          RESPONSE=$(curl -s http://10.50.31.23/oracle-test || true)
          echo "üîç Respuesta: $RESPONSE"
          echo "$RESPONSE" | grep -q "Conectado a Oracle correctamente" \
            && echo "‚úÖ Conexi√≥n a Oracle verificada con √©xito en DEV." \
            || (echo "‚ùå Error: No se pudo validar la conexi√≥n con Oracle en DEV." && exit 1)


  # =========================================================
  # DEPLOY PROD (solo si la rama es main)
  # =========================================================
  deploy-prod:
    name: Deploy to Production (VMware)
    needs: build-test
    if: github.ref == 'refs/heads/main'
    runs-on: self-hosted

    steps:
      - name: Desplegar aplicaci√≥n en entorno PROD (Ubuntu VMware)
        run: |
          echo "üöÄ Desplegando en VM Ubuntu (VMware - 137.0.30.7)..."
          ssh -o StrictHostKeyChecking=no ubuntu@137.0.30.7 "
            set -e
            cd /var/www/html/HybridFlow-OracleApp &&
            sudo chown -R ubuntu:ubuntu /var/www/html/HybridFlow-OracleApp &&
            git fetch origin main &&
            git reset --hard origin/main &&
            git pull origin main &&
            cd backend &&
            composer install --no-interaction --prefer-dist --optimize-autoloader &&
            php artisan config:clear &&
            php artisan cache:clear &&
            php artisan migrate --force
          "

      - name: Validar conexi√≥n Oracle (Health Check - PROD)
        run: |
          echo "ü©∫ Verificando conexi√≥n a Oracle (PROD)..."
          RESPONSE=$(curl -s http://137.0.30.7/oracle-test || true)
          echo "üîç Respuesta: $RESPONSE"
          echo "$RESPONSE" | grep -q "Conectado a Oracle correctamente" \
            && echo "‚úÖ Conexi√≥n a Oracle verificada con √©xito en PROD." \
            || (echo "‚ùå Error: No se pudo validar la conexi√≥n con Oracle en PROD." && exit 1)
