name: CI/CD OracleApp - HybridFlow

on:
  push:
    branches:
      - pablo-dev
      - luis-dev
      - develop
      - main

  # Permite ejecutar el deploy a PRODUCCIÓN de forma manual y programada
  workflow_dispatch:
    inputs:
      scheduled_time:
        description: "Fecha y hora EXACTA para el deploy a producción (YYYY-MM-DD HH:MM)"
        required: true
        type: string
      run_migrations:
        description: "¿Ejecutar migraciones en PRODUCCIÓN?"
        required: true
        default: "no"
        type: choice
        options:
          - "yes"
          - "no"

concurrency:
  group: oracleapp-${{ github.ref }}
  cancel-in-progress: true

# =========================================================
# BUILD + TEST
# =========================================================
jobs:
  build-test:
    name: Build, Test & Quality Check
    runs-on: self-hosted

    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Mostrar entorno del runner
        run: |
          echo "Runner activo: $(hostname)"
          uname -a

      # ---------- FRONTEND ----------
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Instalar dependencias frontend
        working-directory: ./frontend
        run: npm ci

      - name: Ejecutar pruebas Jest del frontend
        env:
          CI: true
        working-directory: ./frontend
        run: npm test -- --watchAll=false

      # ---------- BACKEND ----------
      - name: Verificar PHP y Composer
        run: |
          php -v
          composer --version

      - name: Instalar dependencias backend
        working-directory: ./backend
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Preparar entorno Laravel (.env y APP_KEY)
        working-directory: ./backend
        run: |
          if [ ! -f .env ]; then
            cp .env.example .env
          fi
          php artisan key:generate --force

      - name: Ejecutar pruebas backend
        working-directory: ./backend
        run: |
          if ls tests/**/*.php >/dev/null 2>&1; then
            php artisan test --no-interaction
          else
            echo "No hay pruebas en Laravel."
          fi

# =========================================================
# DEPLOY DEV (Proxmox)
# =========================================================
  deploy-dev:
    name: Deploy to Development (Proxmox)
    needs: build-test
    if: contains(fromJson('["refs/heads/develop", "refs/heads/pablo-dev"]'), github.ref)
    runs-on: self-hosted

    steps:
      - name: Desplegar aplicación en entorno DEV (Ubuntu Proxmox)
        run: |
          echo "Deploy en Proxmox..."
          ssh -o StrictHostKeyChecking=no ubuntu@10.50.31.23 "
            set -e
            cd /var/www/html/HybridFlow-OracleApp &&
            git fetch origin develop &&
            git reset --hard origin/develop &&
            git pull origin develop &&

            cd backend &&
            composer install --no-interaction --prefer-dist --optimize-autoloader &&
            php artisan migrate --force
          "

# =========================================================
# JOB DE ESPERA → PARA PROGRAMAR LA HORA DE PRODUCCIÓN
# =========================================================
  wait-for-prod:
    name: Esperar hasta la hora programada por el usuario
    runs-on: ubuntu-latest
    needs: build-test
    if: github.event_name == 'workflow_dispatch'

    outputs:
      run_migrations: ${{ github.event.inputs.run_migrations }}

    steps:
      - name: Calcular segundos a esperar
        id: calc
        run: |
          TARGET="${{ github.event.inputs.scheduled_time }}"
          echo "Hora objetivo: $TARGET"

          TARGET_TS=$(date -d "$TARGET" +%s)
          NOW_TS=$(date +%s)

          if [ "$TARGET_TS" -le "$NOW_TS" ]; then
            echo "ERROR: La hora ya pasó."
            exit 1
          fi

          WAIT=$(( TARGET_TS - NOW_TS ))
          echo "Segundos a esperar: $WAIT"
          echo "wait_seconds=$WAIT" >> $GITHUB_OUTPUT

      - name: Esperando hasta la hora seleccionada...
        run: |
          sleep ${{ steps.calc.outputs.wait_seconds }}

# =========================================================
# DEPLOY PROD (VMWARE) — PROGRAMADO
# =========================================================
  deploy-prod:
    name: Deploy to Production (VMware)
    needs: wait-for-prod
    runs-on: self-hosted
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Deploy en PRODUCCIÓN
        env:
          RUN_MIGRATIONS: ${{ needs.wait-for-prod.outputs.run_migrations }}
        run: |
          echo "Deploy programado ejecutándose ahora..."
          echo "Migraciones: $RUN_MIGRATIONS"

          ssh -o StrictHostKeyChecking=no ubuntu@137.0.30.7 "
            set -e
            cd /var/www/html/HybridFlow-OracleApp &&
            git fetch origin main &&
            git reset --hard origin/main &&
            git pull origin main &&

            cd backend &&
            composer install --no-interaction --prefer-dist --optimize-autoloader &&
            php artisan config:clear &&
            php artisan cache:clear &&
            php artisan config:cache &&

            if [ \"$RUN_MIGRATIONS\" = \"yes\" ]; then
              php artisan migrate --force
            fi
          "

      - name: Validar conexión Oracle (Health Check - PROD)
        run: |
          RESPONSE=$(curl -s http://137.0.30.7/oracle-test || true)
          echo "$RESPONSE" | grep -q "Conectado a Oracle correctamente" \
            && echo "Deploy a PRODUCCIÓN completado exitosamente." \
            || (echo "Fallo en producción." && exit 1)
