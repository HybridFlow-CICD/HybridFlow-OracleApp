name: CI/CD OracleApp - HybridFlow

on:
  push:
    branches:
      - pablo-dev
      - luis-dev
      - develop
      - main

  workflow_dispatch:
    inputs:
      scheduled_time_cr:
        description: "Fecha y hora en COSTA RICA (YYYY-MM-DD HH:MM)"
        required: true
        type: string

      run_migrations:
        description: "¬øEjecutar migraciones en PRODUCCI√ìN?"
        required: true
        default: "no"
        type: choice
        options:
          - "yes"
          - "no"

concurrency:
  group: oracleapp-${{ github.ref }}
  cancel-in-progress: true

# ======================================================
# BUILD & TEST
# ======================================================
jobs:
  build-test:
    name: Build, Test & Quality Check
    runs-on: self-hosted

    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4

      - name: Mostrar entorno del runner
        run: |
          echo "Runner activo: $(hostname)"
          uname -a
      # ---------- FRONTEND ----------
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Instalar dependencias frontend
        working-directory: ./frontend
        run: npm ci

      - name: Ejecutar pruebas Jest del frontend
        env:
          CI: true
        working-directory: ./frontend
        run: npm test -- --watchAll=false

      # ---------- BACKEND ----------
      - name: Verificar PHP & Composer
        run: |
          php -v
          composer --version
      - name: Instalar dependencias backend
        working-directory: ./backend
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Preparar entorno Laravel
        working-directory: ./backend
        run: |
          if [ ! -f .env ]; then
            cp .env.example .env
          fi
          php artisan key:generate --force
      - name: Ejecutar pruebas backend (PHPUnit)
        working-directory: ./backend
        run: |
          if ls tests/**/*.php >/dev/null 2>&1; then
            php artisan test --no-interaction
          else
            echo "No hay pruebas en Laravel."
          fi
# ======================================================
# DEPLOY DESARROLLO (PROXMOX)
# ======================================================
  deploy-dev:
    name: Deploy to Development (Proxmox)
    needs: build-test
    if: contains(fromJson('["refs/heads/develop", "refs/heads/pablo-dev"]'), github.ref)
    runs-on: self-hosted

    steps:
      - name: Deploy en Proxmox (DEV)
        run: |
          echo "üöÄ Deploy en DEV..."
          ssh -o StrictHostKeyChecking=no ubuntu@10.50.31.23 "
            set -e
            cd /var/www/html/HybridFlow-OracleApp &&
            git fetch origin develop &&
            git reset --hard origin/develop &&
            git pull origin develop &&
            cd backend &&
            sudo chown -R ubuntu:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache
            composer install --no-interaction --prefer-dist --optimize-autoloader
            if ! composer show | grep -q 'yajra/laravel-oci8'; then
              composer require yajra/laravel-oci8:\"^9.5\" --no-interaction
            fi
            php artisan config:clear
            php artisan cache:clear
            php artisan optimize:clear
            php artisan config:cache
            php artisan tinker --execute=\"DB::connection()->getPdo();\" &&
            echo 'Oracle OK en DEV.' ||
            (echo '‚ùå Oracle FAIL en DEV'; exit 1)
            php artisan migrate --force
          "
# ======================================================
# ESPERAR HASTA LA HORA PROGRAMADA (FIX DEFINITIVO)
# ======================================================
  wait-for-prod:
    name: Esperar hasta la hora programada
    runs-on: ubuntu-latest
    needs: build-test
    if: github.event_name == 'workflow_dispatch'

    outputs:
      run_migrations: ${{ github.event.inputs.run_migrations }}

    steps:

      # ---------- Convertir CR ‚Üí UTC ----------
      - name: Convertir hora CR ‚Üí UTC correctamente
        id: convert
        run: |
          CR_RAW="${{ github.event.inputs.scheduled_time_cr }}"
          # Limpiar caracteres invisibles
          CR_TIME=$(echo "$CR_RAW" | tr -d '\r' | tr -d '"' | xargs)
          echo "Hora ingresada (CR limpia): $CR_TIME"
          # Convertir a UTC usando TZ de Costa Rica
          if ! UTC_TIME=$(TZ="America/Costa_Rica" date -d "$CR_TIME" --utc +"%Y-%m-%d %H:%M:%S" 2>/dev/null); then
            echo "‚ùå ERROR: No se pudo interpretar la fecha CR ‚Üí '$CR_RAW'"
            exit 1
          fi
          echo "Hora convertida a UTC: $UTC_TIME"
          echo "utc_time=$UTC_TIME" >> $GITHUB_OUTPUT
      # ---------- Calcular tiempo ----------
      - name: Calcular tiempo de espera
        id: calc
        run: |
          RAW="${{ steps.convert.outputs.utc_time }}"
          TARGET=$(echo "$RAW" | tr -d '\r' | tr -d '"' | xargs)
          echo "Hora objetivo UTC final: $TARGET"
          # Validar con date
          if ! date -d "$TARGET" >/dev/null 2>&1; then
            echo "‚ùå ERROR: Fecha UTC inv√°lida ‚Üí '$TARGET'"
            exit 1
          fi
          TARGET_TS=$(date -d "$TARGET" +%s)
          NOW_TS=$(date -u +%s)
          if [ "$TARGET_TS" -le "$NOW_TS" ]; then
            echo "‚ùå ERROR: La hora indicada ya pas√≥."
            exit 1
          fi
          WAIT=$(( TARGET_TS - NOW_TS ))
          echo "Segundos de espera: $WAIT"
          echo "wait_seconds=$WAIT" >> $GITHUB_OUTPUT
      - name: Esperando...
        run: sleep ${{ steps.calc.outputs.wait_seconds }}


   # ======================================================
  # DEPLOY PRODUCCI√ìN (VMWARE v√≠a t√∫nel SSH)
  # ======================================================
  deploy-prod:
    name: Deploy to Production (VMware via SSH Tunnel)
    needs: wait-for-prod
    runs-on: self-hosted
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Deploy a PRODUCCI√ìN (via t√∫nel SSH reverse)
        env:
          RUN_MIGRATIONS: ${{ needs.wait-for-prod.outputs.run_migrations }}

        run: |
          echo "‚ö° Ejecutando deploy en PRODUCCI√ìN v√≠a t√∫nel SSH..."

          ssh -o StrictHostKeyChecking=no ubuntu@10.50.31.23 << 'EOF_PROXMOX'
            echo "‚û° Entrando a Proxmox. Ahora saltamos a VMware por el t√∫nel :43000"

            ssh -p 43000 -o StrictHostKeyChecking=no ubuntu@localhost << 'EOF_VMWARE'
              set -e
              echo "üöÄ DEPLOY INICIADO EN VMWARE PRODUCCI√ìN"

              # ======================================================
              # üóÇ BACKUP ORACLE
              # ======================================================
              sudo apt-get update -y
              sudo apt-get install -y sshpass

              DUMP_NAME=hybridflow_$(date +%Y%m%d_%H%M%S)
              BACKUP_DIR=/var/backups/hybridflow/${DUMP_NAME}

              echo "üìÅ Carpeta backup: ${BACKUP_DIR}"

              sudo mkdir -p "${BACKUP_DIR}"
              sudo chown ubuntu:ubuntu "${BACKUP_DIR}"

              echo "üì¶ Ejecutando EXPDP en Windows Server..."

              sshpass -p "UTNGRUPO02**" ssh -o StrictHostKeyChecking=no Administrador@137.0.30.3 "
                cd C:/app/oracle/product/19c/dbhome_1/BIN
                ./expdp.exe GRUPO02/\"Grupo02*\" DIRECTORY=DATA_PUMP_DIR DUMPFILE=${DUMP_NAME}.dmp LOGFILE=${DUMP_NAME}.log SCHEMAS=GRUPO02 COMPRESSION=ALL
              "

              echo "‚¨á Descargando dump desde Windows..."

              sshpass -p "UTNGRUPO02**" scp -o StrictHostKeyChecking=no Administrador@137.0.30.3:"C:/app/oracle/admin/orcl/dpdump/${DUMP_NAME}.dmp" "${BACKUP_DIR}/${DUMP_NAME}.dmp"

              sshpass -p "UTNGRUPO02**" scp -o StrictHostKeyChecking=no Administrador@137.0.30.3:"C:/app/oracle/admin/orcl/dpdump/${DUMP_NAME}.log" "${BACKUP_DIR}/${DUMP_NAME}.log"

              echo "‚úî Backup Oracle guardado en ${BACKUP_DIR}"

              # ======================================================
              # DEPLOY LARAVEL
              # ======================================================
              cd /var/www/html/HybridFlow-OracleApp

              git fetch origin main
              git reset --hard origin/main
              git pull origin main

              cd backend

              sudo chown -R ubuntu:www-data storage bootstrap/cache
              sudo chmod -R 775 storage bootstrap/cache

              composer install --no-interaction --prefer-dist --optimize-autoloader

              if ! composer show | grep -q yajra/laravel-oci8; then
                composer require yajra/laravel-oci8:^9.5 --no-interaction
              fi

              php artisan config:clear
              php artisan cache:clear
              php artisan optimize:clear
              php artisan config:cache

              php artisan tinker --execute="DB::connection()->getPdo();" \
                && echo "‚úî Oracle OK en CLI" \
                || { echo "‚ùå Oracle FAIL EN CLI"; exit 1; }

              if [ "${RUN_MIGRATIONS}" = "yes" ]; then
                php artisan migrate --force
              fi

              echo "‚úî DEPLOY COMPLETADO EN PRODUCCI√ìN"
            EOF_VMWARE
          EOF_PROXMOX
