name: CI/CD OracleApp - Development

on:
  push:
    branches:
      - develop
      - luis-dev
      - pablo-dev

concurrency:
  group: oracleapp-dev-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-test:
    name: Build & Test Application
    runs-on: self-hosted   # Runner Linux (grupo02)

    steps:
      # =========================================
      # 1ï¸âƒ£ CÃ“DIGO FUENTE
      # =========================================
      - name: Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: Mostrar entorno del runner
        run: |
          echo "âœ… Runner activo: $(hostname)"
          uname -a

      # =========================================
      # 2ï¸âƒ£ FRONTEND (React)
      # =========================================
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Instalar dependencias frontend
        working-directory: ./frontend
        run: npm ci

      - name: Ejecutar pruebas Jest del frontend
        env:
          CI: true
        working-directory: ./frontend
        run: npm test -- --watchAll=false

      # =========================================
      # 3ï¸âƒ£ BACKEND (Laravel / PHP)
      # =========================================
      - name: Verificar PHP y Composer
        run: |
          set -e
          php -v
          if ! command -v composer >/dev/null 2>&1; then
            echo "ğŸ›  Instalando Composer..."
            EXPECTED_SIGNATURE="$(wget -q -O - https://composer.github.io/installer.sig)"
            php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
            ACTUAL_SIGNATURE="$(php -r "echo hash_file('sha384', 'composer-setup.php');")"
            if [ "$EXPECTED_SIGNATURE" != "$ACTUAL_SIGNATURE" ]; then
              echo 'âŒ ERROR: Instalador de Composer corrupto'; rm composer-setup.php; exit 1
            fi
            sudo php composer-setup.php --install-dir=/usr/local/bin --filename=composer
            rm composer-setup.php
          fi
          composer --version

      - name: CachÃ© de Composer
        uses: actions/cache@v4
        with:
          path: |
            ~/.composer/cache/files
            backend/vendor
          key: composer-${{ hashFiles('backend/composer.lock') }}
          restore-keys: |
            composer-

      - name: Instalar dependencias backend
        working-directory: ./backend
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Preparar entorno Laravel (.env y APP_KEY)
        working-directory: ./backend
        run: |
          set -e
          if [ ! -f .env ]; then
            cp .env.example .env || true
          fi
          php artisan key:generate --force

      - name: Ejecutar pruebas backend (PHPUnit)
        working-directory: ./backend
        run: |
          if ls tests/Feature/*.php >/dev/null 2>&1 || ls tests/Unit/*.php >/dev/null 2>&1; then
            php artisan test --no-interaction
          else
            echo "â„¹ï¸ No hay pruebas en Laravel, se omite este paso."
          fi

           # =========================================
      # =========================================
      # 4ï¸âƒ£ DESPLIEGUE AUTOMÃTICO (local)
      # =========================================
      - name: Desplegar aplicaciÃ³n localmente (Ubuntu OracleApp)
        if: success()
        run: |
          set -e
          echo "ğŸš€ Iniciando despliegue local en la VM Ubuntu (OracleApp)..."
          cd /var/www/html/HybridFlow-OracleApp
          
          echo "ğŸ“¦ Actualizando cÃ³digo desde el repositorio..."
          git pull origin pablo-dev
          
          echo "ğŸ” Verificando dependencias de Laravel..."
          if [ ! -d "backend/vendor" ]; then
            echo "ğŸ“¦ Instalando dependencias de Composer..."
            cd backend
            composer install --no-interaction --prefer-dist --optimize-autoloader
            cd ..
          fi

          echo "ğŸ”‘ Verificando archivo .env..."
          if [ ! -f backend/.env ]; then
            cp backend/.env.example backend/.env
            php backend/artisan key:generate --force
          fi

          echo "ğŸ”§ Aplicando migraciones y limpieza de cachÃ©..."
          cd backend
          php artisan migrate --force || echo "â„¹ï¸ No hay migraciones pendientes."
          php artisan config:clear
          php artisan cache:clear

          echo "ğŸ§¹ Corrigiendo permisos..."
          sudo chown -R www-data:www-data /var/www/html/HybridFlow-OracleApp
          sudo chmod -R 755 /var/www/html/HybridFlow-OracleApp

          echo "âœ… Despliegue completado exitosamente en la misma VM (Ubuntu OracleApp)."



      # =========================================
      # 5ï¸âƒ£ FINALIZACIÃ“N
      # =========================================
      - name: Confirmar finalizaciÃ³n
        run: echo "ğŸš€ Pipeline DEV completado con Ã©xito âœ…"
