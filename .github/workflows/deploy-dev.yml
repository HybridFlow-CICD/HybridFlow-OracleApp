name: CI/CD OracleApp - HybridFlow

on:
  push:
    branches:
      - pablo-dev
      - luis-dev
      - develop
      - main

  workflow_dispatch:
    inputs:
      scheduled_time_cr:
        description: "Fecha y hora en COSTA RICA (YYYY-MM-DD HH:MM)"
        required: true
        type: string

      run_migrations:
        description: "¬øEjecutar migraciones en PRODUCCI√ìN?"
        required: true
        default: "no"
        type: choice
        options:
          - "yes"
          - "no"

concurrency:
  group: oracleapp-${{ github.ref }}
  cancel-in-progress: true

jobs:

  # ======================================================
  # BUILD & TEST
  # ======================================================
  build-test:
    name: Build, Test & Quality Check
    runs-on: self-hosted

    steps:
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4

      - name: Mostrar entorno del runner
        run: |
          echo "Runner activo: $(hostname)"
          uname -a

      # ---------- FRONTEND ----------
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Instalar dependencias frontend
        working-directory: ./frontend
        run: npm ci

      - name: Ejecutar pruebas Jest del frontend
        env:
          CI: true
        working-directory: ./frontend
        run: npm test -- --watchAll=false

      # ---------- BACKEND ----------
      - name: Verificar PHP & Composer
        run: |
          php -v
          composer --version

      - name: Instalar dependencias backend
        working-directory: ./backend
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Preparar entorno Laravel
        working-directory: ./backend
        run: |
          if [ ! -f .env ]; then
            cp .env.example .env
          fi
          php artisan key:generate --force

      - name: Ejecutar pruebas backend (PHPUnit)
        working-directory: ./backend
        run: |
          if ls tests/**/*.php >/dev/null 2>&1; then
            php artisan test --no-interaction
          else
            echo "No hay pruebas en Laravel."
          fi

  # ======================================================
  # DEPLOY DESARROLLO (PROXMOX)
  # ======================================================
  deploy-dev:
    name: Deploy to Development (Proxmox)
    needs: build-test
    if: contains(fromJson('["refs/heads/develop", "refs/heads/pablo-dev"]'), github.ref)
    runs-on: self-hosted

    steps:
      - name: Deploy en Proxmox (DEV)
        run: |
          echo "üöÄ Deploy en DEV..."
          ssh -o StrictHostKeyChecking=no ubuntu@10.50.31.23 "
            set -e

            echo '‚û° DEPLOY FRONTEND DEV'

            cd /var/www/html/HybridFlow-OracleApp
            git fetch origin develop
            git reset --hard origin/develop
            git pull origin develop

            # =========================
            # FRONTEND DEV
            # =========================
            cd frontend
            npm ci --legacy-peer-deps
            npm run build

            sudo rm -rf /var/www/html/frontend-app/*
            sudo mkdir -p /var/www/html/frontend-app
            sudo cp -r build/* /var/www/html/frontend-app/

            echo '‚úî Frontend actualizado en DEV'

            # =========================
            # BACKEND DEV (LARAVEL)
            # =========================
            cd /var/www/html/HybridFlow-OracleApp/backend

            sudo chown -R ubuntu:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache

            composer install --no-interaction --prefer-dist --optimize-autoloader

            if ! composer show | grep -q 'yajra/laravel-oci8'; then
              composer require yajra/laravel-oci8:\"^9.5\" --no-interaction
            fi

            php artisan config:clear
            php artisan cache:clear
            php artisan optimize:clear
            php artisan config:cache

            php artisan tinker --execute=\"DB::connection()->getPdo();\" \
              && echo 'Oracle OK en DEV.' \
              || { echo '‚ùå Oracle FAIL en DEV'; exit 1; }

            php artisan migrate --force
          "


  # ======================================================
  # ESPERAR HASTA LA HORA PROGRAMADA
  # ======================================================
  wait-for-prod:
    name: Esperar hasta la hora programada
    runs-on: ubuntu-latest
    needs: build-test
    if: github.event_name == 'workflow_dispatch'

    outputs:
      run_migrations: ${{ github.event.inputs.run_migrations }}

    steps:

      - name: Convertir hora CR ‚Üí UTC
        id: convert
        run: |
          CR_RAW="${{ github.event.inputs.scheduled_time_cr }}"
          CR_TIME=$(echo "$CR_RAW" | tr -d '\r' | tr -d '"' | xargs)
          echo "Hora ingresada (CR): $CR_TIME"

          if ! UTC_TIME=$(TZ="America/Costa_Rica" date -d "$CR_TIME" --utc +"%Y-%m-%d %H:%M:%S" 2>/dev/null); then
            echo "‚ùå ERROR: No se pudo interpretar la fecha"
            exit 1
          fi

          echo "utc_time=$UTC_TIME" >> $GITHUB_OUTPUT

      - name: Calcular tiempo de espera
        id: calc
        run: |
          TARGET="${{ steps.convert.outputs.utc_time }}"
          TARGET_TS=$(date -d "$TARGET" +%s)
          NOW_TS=$(date -u +%s)

          if [ "$TARGET_TS" -le "$NOW_TS" ]; then
            echo "‚ùå ERROR: La hora ya pas√≥"
            exit 1
          fi

          WAIT=$(( TARGET_TS - NOW_TS ))
          echo "wait_seconds=$WAIT" >> $GITHUB_OUTPUT

      - name: Esperando...
        run: sleep ${{ steps.calc.outputs.wait_seconds }}


  # ======================================================
  # Deploy Producci√≥n (VMware via SSH Tunnel)
  # ======================================================

  deploy-prod:
    name: Deploy to Production (VMware via SSH Tunnel)
    needs: wait-for-prod
    runs-on: self-hosted
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Deploy a PRODUCCI√ìN (via t√∫nel SSH reverse)
        env:
          RUN_MIGRATIONS: yes

        run: |
          echo "‚ö° Ejecutando deploy en PRODUCCI√ìN v√≠a t√∫nel SSH..."

          ssh -o StrictHostKeyChecking=no ubuntu@10.50.31.23 << 'OUTER'
            echo "‚û° Entrando a Proxmox. Saltando a VMware por el t√∫nel :43000"

            ssh -p 43000 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ubuntu@localhost << 'INNER'
              set -e
              echo "üöÄ DEPLOY INICIADO EN VMWARE PRODUCCI√ìN"

              # ==================================
              # ACTUALIZAR C√ìDIGO DESDE MAIN (HTTPS)
              # ==================================
              cd /var/www/html/HybridFlow-OracleApp
              echo "üì• Descargando √∫ltimas actualizaciones (HTTPS)..."

              git remote remove origin 2>/dev/null || true
              git remote add origin "https://github.com/HybridFlow-CICD/HybridFlow-OracleApp.git"

              git fetch origin main
              git reset --hard origin/main

              echo "‚úî C√≥digo actualizado desde MAIN correctamente"

              # ==================================
              # BACKUP ORACLE
              # ==================================
              sudo apt-get update -y
              sudo apt-get install -y sshpass unzip

              DUMP_NAME=hybridflow_$(date +%Y%m%d_%H%M%S)
              BACKUP_DIR=/var/backups/hybridflow/$DUMP_NAME

              sudo mkdir -p "$BACKUP_DIR"
              sudo chown ubuntu:ubuntu "$BACKUP_DIR"

              echo "üì¶ Ejecutando EXPDP en Windows Server..."
              sshpass -p "UTNGRUPO02**" ssh -o StrictHostKeyChecking=no Administrador@137.0.30.3 "
                cd 'C:/app/oracle/product/19c/dbhome_1/BIN'
                ./expdp.exe GRUPO02/\\\"Grupo02*\\\" DIRECTORY=DATA_PUMP_DIR \
                  DUMPFILE=$DUMP_NAME.dmp LOGFILE=$DUMP_NAME.log \
                  SCHEMAS=GRUPO02 COMPRESSION=ALL
              "

              sshpass -p "UTNGRUPO02**" scp -o StrictHostKeyChecking=no \
                Administrador@137.0.30.3:"C:/app/oracle/admin/orcl/dpdump/$DUMP_NAME.dmp" "$BACKUP_DIR/"
              sshpass -p "UTNGRUPO02**" scp -o StrictHostKeyChecking=no \
                Administrador@137.0.30.3:"C:/app/oracle/admin/orcl/dpdump/$DUMP_NAME.log" "$BACKUP_DIR/"

              echo "‚úî Backup Oracle guardado en: $BACKUP_DIR"

              # ==================================
              # FRONTEND
              # ==================================
              cd /var/www/html/HybridFlow-OracleApp/frontend
              npm install --legacy-peer-deps
              npm run build

              sudo rm -rf /var/www/html/frontend-app
              sudo mkdir -p /var/www/html/frontend-app
              sudo cp -r build/* /var/www/html/frontend-app/

              echo "‚úî Frontend desplegado en PRODUCCI√ìN"

              # ==================================
              # BACKEND (Laravel)
              # ==================================
              cd /var/www/html/HybridFlow-OracleApp/backend

              sudo chown -R ubuntu:www-data storage bootstrap/cache
              sudo chmod -R 775 storage bootstrap/cache

              composer install --no-interaction --prefer-dist --optimize-autoloader

              if ! composer show | grep -q yajra/laravel-oci8; then
                composer require yajra/laravel-oci8:"^9.5" --no-interaction
              fi

              # ==================================
              # OCI8 SOLO SE INSTALA SI FALTA
              # ==================================
              echo "üì¶ Verificando Oracle Instant Client..."

              if ! php -m | grep -q oci8; then
                echo "üîß Instalando OCI8 (solo si faltaba)..."
                sudo phpenmod oci8 || true
                sudo phpenmod pdo_oci || true
                sudo systemctl restart apache2
              fi

              echo "üîç Verificando OCI cargado..."
              php -m | grep -E "oci8|pdo_oci" || { echo '‚ùå OCI NO carg√≥'; exit 1; }

              # ========= CACHE LARAVEL + MIGRACIONES =========
              php artisan config:clear
              php artisan cache:clear
              php artisan optimize:clear
              php artisan config:cache

              echo "üîå Probando conexi√≥n Oracle..."
              php artisan tinker --execute="DB::connection()->getPdo();" \
                && echo '‚úî Oracle OK CLI' \
                || { echo '‚ùå Conexi√≥n Oracle FAIL'; exit 1; }

              echo "üõ† Ejecutando migraciones..."
              php artisan migrate --force

              echo "‚úî DEPLOY PRODUCCI√ìN COMPLETADO"
            INNER
          OUTER

      # ========= HEALTH CHECK =========
      - name: Health Check Oracle (Proxmox ‚Üí VMware v√≠a t√∫nel)
        run: |
          echo "üîç Ejecutando Health Check Oracle v√≠a t√∫nel..."

          ssh -o StrictHostKeyChecking=no ubuntu@10.50.31.23 << 'CHECK'
            ssh -p 43000 -o StrictHostKeyChecking=no ubuntu@localhost "
              RESP=\$(curl -s http://127.0.0.1/oracle-test)
              echo \"Respuesta del endpoint: \$RESP\"

              if echo \"\$RESP\" | grep -q \"Conectado a Oracle correctamente\"; then
                echo \"‚úî Oracle OK en PRODUCCI√ìN (WEB)\"
              else
                echo \"‚ùå Oracle NO responde en PRODUCCI√ìN (WEB)\"
                exit 1
              fi
            "
          CHECK

  notify-discord:
    name: Notificar a Discord
    needs: [deploy-prod]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Enviar notificaci√≥n a Discord
        run: |
          STATUS="${{ job.status }}"
          COLOR="16711680" # rojo

          if [ "$STATUS" = "success" ]; then
            COLOR="3066993" # verde
          fi

          PAYLOAD=$(jq -n \
            --arg content "**CI/CD HybridFlow**" \
            --arg status "$STATUS" \
            --arg url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --argjson color "$COLOR" \
            '{content: $content,
              embeds: [
                {
                  title: "Estado del Pipeline",
                  description: ("Resultado: **" + $status + "**\n[Ver ejecuci√≥n](" + $url + ")"),
                  color: $color
                }
              ]
            }')

          curl -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              ${{ secrets.DISCORD_WEBHOOK }}   