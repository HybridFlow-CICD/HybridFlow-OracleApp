name: CI/CD OracleApp - HybridFlow

on:
  push:
    branches:
      - pablo-dev
      - luis-dev
      - develop
      - main

  workflow_dispatch:
    inputs:
      scheduled_time_cr:
        description: "Fecha y hora en COSTA RICA (YYYY-MM-DD HH:MM)"
        required: true
        type: string

      run_migrations:
        description: "Â¿Ejecutar migraciones en PRODUCCIÃ“N?"
        required: true
        default: "no"
        type: choice
        options:
          - "yes"
          - "no"

concurrency:
  group: oracleapp-${{ github.ref }}
  cancel-in-progress: true

# ======================================================
# BUILD & TEST
# ======================================================
jobs:
  build-test:
    name: Build, Test & Quality Check
    runs-on: self-hosted

    steps:
      - name: Checkout del cÃ³digo
        uses: actions/checkout@v4

      - name: Mostrar entorno del runner
        run: |
          echo "Runner activo: $(hostname)"
          uname -a

      # ---------- FRONTEND ----------
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Instalar dependencias frontend
        working-directory: ./frontend
        run: npm ci

      - name: Ejecutar pruebas Jest del frontend
        env:
          CI: true
        working-directory: ./frontend
        run: npm test -- --watchAll=false

      # ---------- BACKEND ----------
      - name: Verificar PHP & Composer
        run: |
          php -v
          composer --version

      - name: Instalar dependencias backend
        working-directory: ./backend
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Preparar entorno Laravel
        working-directory: ./backend
        run: |
          if [ ! -f .env ]; then
            cp .env.example .env
          fi
          php artisan key:generate --force

      - name: Ejecutar pruebas backend (PHPUnit)
        working-directory: ./backend
        run: |
          if ls tests/**/*.php >/dev/null 2>&1; then
            php artisan test --no-interaction
          else
            echo "No hay pruebas en Laravel."
          fi

# ======================================================
# DEPLOY DESARROLLO (PROXMOX)
# ======================================================
  deploy-dev:
    name: Deploy to Development (Proxmox)
    needs: build-test
    if: contains(fromJson('["refs/heads/develop", "refs/heads/pablo-dev"]'), github.ref)
    runs-on: self-hosted

    steps:
      - name: Deploy en Proxmox (DEV)
        run: |
          echo "ðŸš€ Deploy en DEV..."

          ssh -o StrictHostKeyChecking=no ubuntu@10.50.31.23 "
            set -e

            cd /var/www/html/HybridFlow-OracleApp &&
            git fetch origin develop &&
            git reset --hard origin/develop &&
            git pull origin develop &&

            cd backend &&

            sudo chown -R ubuntu:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache

            composer install --no-interaction --prefer-dist --optimize-autoloader

            if ! composer show | grep -q 'yajra/laravel-oci8'; then
              composer require yajra/laravel-oci8:\"^9.5\" --no-interaction
            fi

            php artisan config:clear
            php artisan cache:clear
            php artisan optimize:clear
            php artisan config:cache

            php artisan tinker --execute=\"DB::connection()->getPdo();\" &&
            echo 'Oracle OK en DEV.' ||
            (echo 'âŒ Oracle FAIL en DEV'; exit 1)

            php artisan migrate --force
          "

# ======================================================
# ESPERAR HASTA LA HORA PROGRAMADA (FIX DEFINITIVO)
# ======================================================
  wait-for-prod:
    name: Esperar hasta la hora programada
    runs-on: ubuntu-latest
    needs: build-test
    if: github.event_name == 'workflow_dispatch'

    outputs:
      run_migrations: ${{ github.event.inputs.run_migrations }}

    steps:

      # ---------- Convertir CR â†’ UTC ----------
      - name: Convertir hora CR â†’ UTC correctamente
        id: convert
        run: |
          CR_RAW="${{ github.event.inputs.scheduled_time_cr }}"

          # Limpiar caracteres invisibles
          CR_TIME=$(echo "$CR_RAW" | tr -d '\r' | tr -d '"' | xargs)

          echo "Hora ingresada (CR limpia): $CR_TIME"

          # Convertir a UTC usando TZ de Costa Rica
          if ! UTC_TIME=$(TZ="America/Costa_Rica" date -d "$CR_TIME" --utc +"%Y-%m-%d %H:%M:%S" 2>/dev/null); then
            echo "âŒ ERROR: No se pudo interpretar la fecha CR â†’ '$CR_RAW'"
            exit 1
          fi

          echo "Hora convertida a UTC: $UTC_TIME"
          echo "utc_time=$UTC_TIME" >> $GITHUB_OUTPUT

      # ---------- Calcular tiempo ----------
      - name: Calcular tiempo de espera
        id: calc
        run: |
          RAW="${{ steps.convert.outputs.utc_time }}"
          TARGET=$(echo "$RAW" | tr -d '\r' | tr -d '"' | xargs)

          echo "Hora objetivo UTC final: $TARGET"

          # Validar con date
          if ! date -d "$TARGET" >/dev/null 2>&1; then
            echo "âŒ ERROR: Fecha UTC invÃ¡lida â†’ '$TARGET'"
            exit 1
          fi

          TARGET_TS=$(date -d "$TARGET" +%s)
          NOW_TS=$(date -u +%s)

          if [ "$TARGET_TS" -le "$NOW_TS" ]; then
            echo "âŒ ERROR: La hora indicada ya pasÃ³."
            exit 1
          fi

          WAIT=$(( TARGET_TS - NOW_TS ))

          echo "Segundos de espera: $WAIT"
          echo "wait_seconds=$WAIT" >> $GITHUB_OUTPUT

      - name: Esperando...
        run: sleep ${{ steps.calc.outputs.wait_seconds }}

          # ======================================================
  # DEPLOY PRODUCCIÃ“N (VMWARE vÃ­a tÃºnel SSH)
  # ======================================================
  deploy-prod:
    name: Deploy to Production (VMware via SSH Tunnel)
    needs: wait-for-prod
    runs-on: self-hosted
    if: github.event_name == 'workflow_dispatch'

    steps:

      - name: Deploy a PRODUCCIÃ“N (via tÃºnel SSH reverse)
        env:
          RUN_MIGRATIONS: ${{ needs.wait-for-prod.outputs.run_migrations }}

        run: |
          echo "âš¡ Ejecutando deploy en PRODUCCIÃ“N vÃ­a tÃºnel SSH..."

          ssh -o StrictHostKeyChecking=no ubuntu@10.50.31.23 "
            echo 'âž¡ Conectando a VMware mediante tÃºnel reverse :43000...'

            ssh -p 43000 -o StrictHostKeyChecking=no ubuntu@localhost '
              set -e
              echo \"ðŸš€ Iniciando deploy en VMware...\"

              # ======================================================
              # ðŸ“‚ CREAR CARPETA DE BACKUPS
              # ======================================================
              sudo mkdir -p /var/backups/hybridflow
              sudo chown -R ubuntu:ubuntu /var/backups/hybridflow
              sudo chmod -R 775 /var/backups/hybridflow

              BACKUP_DIR=\"/var/backups/hybridflow/\$(date +\"%Y-%m-%d_%H-%M-%S\")\"
              mkdir -p \"\$BACKUP_DIR\"
              echo \"ðŸ“ Backup guardado en: \$BACKUP_DIR\"

              # ======================================================
              # ðŸ—‚ BACKUP FRONTEND
              # ======================================================
              echo \"ðŸ—‚ Respaldando FRONTEND...\"
              sudo cp -r /var/www/html/HybridFlow-OracleApp/frontend \"\$BACKUP_DIR/frontend\" || exit 1

              # ======================================================
              # ðŸ—‚ BACKUP BACKEND
              # ======================================================
              echo \"ðŸ—‚ Respaldando BACKEND...\"
              sudo cp -r /var/www/html/HybridFlow-OracleApp/backend \"\$BACKUP_DIR/backend\" || exit 1

              # ======================================================
              # ðŸ—„ BACKUP ORACLE (Windows Server)
              # ======================================================
              echo \"ðŸ—„ Respaldando ORACLE...\"

              DUMP_NAME=\"hybridflow_\$(date +\"%Y%m%d_%H%M%S\")\"

              ssh -o StrictHostKeyChecking=no Administrator@137.0.30.3 \"powershell -Command \\\"
                expdp GRUPO02/Grupo02* DIRECTORY=DATA_PUMP_DIR DUMPFILE=$DUMP_NAME.dmp LOGFILE=$DUMP_NAME.log SCHEMAS=GRUPO02 COMPRESSION=ALL
              \\\"
              \" || { echo \"âŒ ERROR ejecutando expdp en Windows\"; exit 1; }

              echo \"â¬‡ Descargando dump desde Windows...\"

              scp -o StrictHostKeyChecking=no \
                Administrator@137.0.30.3:\"C:/app/oracle/admin/orcl/dpdump/$DUMP_NAME.dmp\" \
                \"\$BACKUP_DIR/$DUMP_NAME.dmp\" || exit 1

              scp -o StrictHostKeyChecking=no \
                Administrator@137.0.30.3:\"C:/app/oracle/admin/orcl/dpdump/$DUMP_NAME.log\" \
                \"\$BACKUP_DIR/$DUMP_NAME.log\" || exit 1

              echo \"âœ” Backup Oracle completado correctamente\"

              # ======================================================
              # ðŸš€ DEPLOY LARAVEL
              # ======================================================
              cd /var/www/html/HybridFlow-OracleApp &&
              git fetch origin main &&
              git reset --hard origin/main &&
              git pull origin main

              cd backend
              sudo chown -R ubuntu:www-data storage bootstrap/cache
              sudo chmod -R 775 storage bootstrap/cache

              composer install --no-interaction --prefer-dist --optimize-autoloader

              if ! composer show | grep -q \"yajra/laravel-oci8\"; then
                composer require yajra/laravel-oci8:\"^9.5\" --no-interaction
              fi

              php artisan config:clear
              php artisan cache:clear
              php artisan optimize:clear
              php artisan config:cache

              php artisan tinker --execute=\"DB::connection()->getPdo();\" || exit 1

              if [ \"${RUN_MIGRATIONS}\" = \"yes\" ]; then
                php artisan migrate --force
              fi

              echo \"âœ” DEPLOY COMPLETADO EN PRODUCCIÃ“N\"
            '
          "
